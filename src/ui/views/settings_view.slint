import { Theme, AppI18n } from "../theme.slint";
import { CustomScrollbar } from "../components/scrollbar.slint";
import {
    CustomLineEdit,
    CustomComboBox,
    CustomCheckBox,
    CustomButton,
} from "../components/form_widgets.slint";

export component SettingsView inherits Rectangle {
    in-out property <string> ui_language: "auto";
    in-out property <string> distro_location: "";
    in-out property <string> logs_location: "";
    in-out property <int> log_level: 3;
    in-out property <int> log_days: 7;
    in-out property <int> check_update_interval: 7;
    in-out property <bool> auto_shutdown: false;
    private property <bool> open-dropdown: combo-lang.open-dropdown || combo-log.open-dropdown || combo-log-retention.open-dropdown || combo-update.open-dropdown;

    // Language support configuration
    private property <[string]> language-options: [
        AppI18n.t("settings.languages.auto", [AppI18n.version]),
        AppI18n.t("settings.languages.en", [AppI18n.version]),
        AppI18n.t("settings.languages.zh_cn", [AppI18n.version]),
        AppI18n.t("settings.languages.zh_tw", [AppI18n.version]),
        AppI18n.t("settings.languages.fr", [AppI18n.version]),
        AppI18n.t("settings.languages.es", [AppI18n.version]),
        AppI18n.t("settings.languages.ru", [AppI18n.version]),
        AppI18n.t("settings.languages.pt", [AppI18n.version]),
        AppI18n.t("settings.languages.de", [AppI18n.version]),
        AppI18n.t("settings.languages.ja", [AppI18n.version]),
        AppI18n.t("settings.languages.hi", [AppI18n.version]),
        AppI18n.t("settings.languages.bn", [AppI18n.version]),
        AppI18n.t("settings.languages.id", [AppI18n.version]),
        AppI18n.t("settings.languages.it", [AppI18n.version]),
        AppI18n.t("settings.languages.tr", [AppI18n.version])
    ];
    private property <[string]> log-level-options: [
        AppI18n.t("settings.log_levels.error", [AppI18n.version]),
        AppI18n.t("settings.log_levels.warn", [AppI18n.version]),
        AppI18n.t("settings.log_levels.info", [AppI18n.version]),
        AppI18n.t("settings.log_levels.debug", [AppI18n.version]),
        AppI18n.t("settings.log_levels.trace", [AppI18n.version])
    ];
    private property <[string]> log-days-options: [
        AppI18n.t("settings.log_retention_options.seven_days", [AppI18n.version]),
        AppI18n.t("settings.log_retention_options.half_month", [AppI18n.version]),
        AppI18n.t("settings.log_retention_options.one_month", [AppI18n.version])
    ];
    private property <[string]> check-update-options: [
        AppI18n.t("settings.update_options.daily", [AppI18n.version]),
        AppI18n.t("settings.update_options.weekly", [AppI18n.version]),
        AppI18n.t("settings.update_options.biweekly", [AppI18n.version]),
        AppI18n.t("settings.update_options.monthly", [AppI18n.version])
    ];
       
    // Calculate selected index based on check_update_interval
    pure function get-check-update-index(days: int) -> int {
        if (days == 1) {
            return 0;
        }
        if (days == 7) {
            return 1;
        }
        if (days == 15) {
            return 2;
        }
        if (days == 30) {
            return 3;
        }
        return 1;
    }

    // Calculate selected index based on log_days
    pure function get-log-days-index(days: int) -> int {
        if (days == 7) {
            return 0;
        }
        if (days == 15) {
            return 1;
        }
        if (days == 30) {
            return 2;
        }
        return 0;
    }
    
    // Calculate selected index based on ui_language
    pure function get-language-index(lang: string) -> int {
        if (lang == "en") {
            return 1;
        }
        if (lang == "zh-CN") {
            return 2;
        }
        if (lang == "zh-TW") {
            return 3;
        }
        if (lang == "fr") {
            return 4;
        }
        if (lang == "es") {
            return 5;
        }
        if (lang == "ru") {
            return 6;
        }
        if (lang == "pt") {
            return 7;
        }
        if (lang == "de") {
            return 8;
        }
        if (lang == "ja") {
            return 9;
        }
        if (lang == "hi") {
            return 10;
        }
        if (lang == "bn") {
            return 11;
        }
        if (lang == "id") {
            return 12;
        }
        if (lang == "it") {
            return 13;
        }
        if (lang == "tr") {
            return 14;
        }
        return 0;
    }
    
    // Intermediate mutable property for ComboBox
    property <int> selected-language-index: get-language-index(ui_language);
    property <int> selected-check-update-index: get-check-update-index(check_update_interval);
    callback save-settings();
    callback select-distro-folder();
    callback select-logs-folder();
    background: transparent;
    VerticalLayout {
        spacing: 0;
        
        // Configuration form area (with scroll)
        content-wrapper := Rectangle {
            vertical-stretch: 1;
            background: transparent;
            z: 1; // Ensure this and its children stay above the Save button area
            clip: true;
            flickable := Flickable {
                viewport-height: content-layout.preferred-height;
                width: parent.width;
                height: 100%;
                interactive: !root.open-dropdown;
                content-layout := VerticalLayout {
                    padding-left: 4px;
                    padding-right: 16px;
                    padding-top: 4px;
                    padding-bottom: 4px; // Minimal padding
                    spacing: 10px; // Reduced as we flattened layout
                    alignment: start;

                    // 1. Software language and Update check
                    Rectangle {
                        z: 50;
                        height: lang-grid.preferred-height;
                        lang-grid := GridLayout {
                            spacing: 12px;
                            Row {
                                // Column 1: Software language
                                VerticalLayout {
                                    horizontal-stretch: 1;
                                    preferred-width: 0;
                                    min-width: 0;
                                    spacing: 10px;
                                    Text {
                                        text: AppI18n.t("settings.language", [AppI18n.version]);
                                        font-size: 13px;
                                        color: Theme.text_secondary;
                                    }

                                    combo-lang := CustomComboBox {
                                        model: root.language-options;
                                        current-index <=> root.selected-language-index;
                                        height: 32px;
                                        selected(idx) => {
                                            if (idx == 1) {
                                                root.ui_language = "en";
                                            } else if (idx == 2) {
                                                root.ui_language = "zh-CN";
                                            } else if (idx == 3) {
                                                root.ui_language = "zh-TW";
                                            } else if (idx == 4) {
                                                root.ui_language = "fr";
                                            } else if (idx == 5) {
                                                root.ui_language = "es";
                                            } else if (idx == 6) {
                                                root.ui_language = "ru";
                                            } else if (idx == 7) {
                                                root.ui_language = "pt";
                                            } else if (idx == 8) {
                                                root.ui_language = "de";
                                            } else if (idx == 9) {
                                                root.ui_language = "ja";
                                            } else if (idx == 10) {
                                                root.ui_language = "hi";
                                            } else if (idx == 11) {
                                                root.ui_language = "bn";
                                            } else if (idx == 12) {
                                                root.ui_language = "id";
                                            } else if (idx == 13) {
                                                root.ui_language = "it";
                                            } else if (idx == 14) {
                                                root.ui_language = "tr";
                                            } else {
                                                root.ui_language = "auto";
                                            }
                                        }
                                    }
                                }

                                // Column 2: Auto check update interval
                                VerticalLayout {
                                    horizontal-stretch: 1;
                                    preferred-width: 0;
                                    min-width: 0;
                                    spacing: 10px;
                                    Text {
                                        text: AppI18n.t("settings.update_interval", [AppI18n.version]);
                                        font-size: 13px;
                                        color: Theme.text_secondary;
                                    }

                                    combo-update := CustomComboBox {
                                        model: root.check-update-options;
                                        current-index <=> root.selected-check-update-index;
                                        height: 32px;
                                        dropdown-height: 100px;
                                        selected(idx) => {
                                            if (idx == 0) {
                                                root.check_update_interval = 1;
                                            } else if (idx == 1) {
                                                root.check_update_interval = 7;
                                            } else if (idx == 2) {
                                                root.check_update_interval = 15;
                                            } else if (idx == 3) {
                                                root.check_update_interval = 30;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Rectangle {
                        height: 7px;
                    } // Spacer

                    // 2. Log level and Retention days
                    Rectangle {
                        z: 40;
                        height: log-grid.preferred-height;
                        log-grid := GridLayout {
                            spacing: 12px;
                            Row {
                                // Column 1: Log Level
                                VerticalLayout {
                                    horizontal-stretch: 1;
                                    preferred-width: 0; // Force layout to ignore internal content width
                                    min-width: 0;
                                    spacing: 10px;
                                    Text {
                                        text: AppI18n.t("settings.log_level", [AppI18n.version]);
                                        font-size: 13px;
                                        color: Theme.text_secondary;
                                    }

                                    combo-log := CustomComboBox {
                                        model: root.log-level-options;
                                        current-index: root.log-level - 1;
                                        height: 32px;
                                        dropdown-height: 100px;
                                        selected(idx) => {
                                            root.log-level = idx + 1;
                                        }
                                    }
                                }

                                // Column 2: Retention Days
                                VerticalLayout {
                                    horizontal-stretch: 1;
                                    preferred-width: 0; // Force layout to ignore internal content width
                                    min-width: 0;
                                    spacing: 10px;
                                    Text {
                                        text: AppI18n.t("settings.log_retention_days", [AppI18n.version]);
                                        font-size: 13px;
                                        color: Theme.text_secondary;
                                    }

                                    combo-log-retention := CustomComboBox {
                                        model: root.log-days-options;
                                        current-index: root.get-log-days-index(root.log_days);
                                        height: 32px;
                                        dropdown-height: 100px;
                                        selected(idx) => {
                                            if (idx == 0) {
                                                root.log_days = 7;
                                            } else if (idx == 1) {
                                                root.log_days = 15;
                                            } else if (idx == 2) {
                                                root.log_days = 30;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Rectangle {
                        height: 7px;
                    } // Spacer

                    // 3. Log path
                    Text {
                        text: AppI18n.t("settings.log_path", [AppI18n.version]);
                        font-size: 13px;
                        color: Theme.text_secondary;
                    }

                    HorizontalLayout {
                        spacing: 6px;
                        CustomLineEdit {
                            text: root.logs_location;
                            enabled: false;
                            horizontal-stretch: 1;
                        }

                        CustomButton {
                            text: AppI18n.t("settings.select_folder", [AppI18n.version]);
                            height: 32px;
                            clicked => {
                                root.select-logs-folder();
                            }
                        }
                    }

                    Rectangle {
                        height: 7px;
                    } // Spacer


                    // 5. Default distribution installation directory
                    Text {
                        text: AppI18n.t("settings.distro_dir", [AppI18n.version]);
                        font-size: 13px;
                        color: Theme.text_secondary;
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        CustomLineEdit {
                            text: root.distro_location;
                            enabled: false;
                            horizontal-stretch: 1;
                        }

                        CustomButton {
                            text: AppI18n.t("settings.select_folder", [AppI18n.version]);
                            height: 32px;
                            clicked => {
                                root.select-distro-folder();
                            }
                        }
                    }

                    Rectangle {
                        height: 7px;
                    } // Spacer
                    
                    // 6. Automatically close subsystem when exiting
                    CustomCheckBox {
                        checked <=> root.auto_shutdown;
                        text: AppI18n.t("settings.auto_shutdown_msg", [AppI18n.version]);
                    }
                }
            }
            
            // Scrollbar
            if (flickable.viewport-height > flickable.height): CustomScrollbar {
                x: parent.width - 12px;
                y: 0;
                width: 8px;
                height: 100%;
                maximum: flickable.viewport-height - flickable.height;
                page_size: flickable.height;
                value: -flickable.viewport-y;
                scroll_to(v) => {
                    flickable.viewport-y = -v;
                }
            }
        }

        HorizontalLayout {
            padding-top: 4px;
            padding-bottom: 4px;
            padding-right: 16px;
            alignment: end;
            CustomButton {
                text: AppI18n.t("settings.save", [AppI18n.version]);
                primary: true;
                height: 32px;
                clicked => {
                    root.save_settings();
                }
            }
        }
    }
}
