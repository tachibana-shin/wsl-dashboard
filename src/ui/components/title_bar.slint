import { Theme, AppInfo, AppI18n, LayoutConstants } from "../theme.slint";
import { WindowControlButton } from "common.slint";

component ThemeSwitch inherits Rectangle {
    callback clicked;
    width: 40px;
    height: 100%;
    Rectangle {
        width: 32px;
        height: 16px;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        border-radius: 8px;
        border-width: 1px;
        border-color: Theme.switch_track_border;
        background: transparent;
        Rectangle {
            x: Theme.dark_mode ? 18px : 2px;
            y: 2px;
            width: 12px;
            height: 12px;
            border-radius: 6px;
            background: Theme.switch_thumb;
            animate x { duration: 150ms; }
        }
    }

    TouchArea {
        clicked => {
            root.clicked();
        }
    }
}

export component TitleBar inherits Rectangle {
    in property <string> title;
    in property <bool> is_maximized;
    in-out property <float> drag_x;
    in-out property <float> drag_y;
    callback close;
    callback minimize;
    callback maximize;
    callback toggle_theme;
    callback drag_delta(float, float);
    height: 40px;
    background: transparent;
    TouchArea {
        width: parent.width;
        height: parent.height;
        pointer-event(event) => {
            if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                root.drag_x = self.mouse-x / 1px;
                root.drag_y = self.mouse-y / 1px;
            }
        }
        moved => {
            if (self.pressed) {
                root.drag_delta(
                    (self.mouse-x / 1px) - root.drag_x,
                    (self.mouse-y / 1px) - root.drag_y);
            }
        }
    }

    Rectangle {
        height: 40px;
        width: parent.width;

        // Title and Version Area
        HorizontalLayout {
            x: AppI18n.is-rtl ? (parent.width - self.width - 3px) : 3px;
            padding-left: AppI18n.is-rtl ? 0 : 42px;
            padding-right: AppI18n.is-rtl ? 42px : 0;
            spacing: 8px;
            alignment: AppI18n.is-rtl ? end : start;
            width: parent.width - 150px; // Ensure it doesn't overlap with controls

            if (AppI18n.is-rtl): Text {
                text: "v" + AppInfo.version;
                font-size: 11px * LayoutConstants.font-scale;
                font-weight: 400;
                font-family: Theme.default_font;
                color: Theme.text_secondary;
                vertical-alignment: center;
            }
            Text {
                text: title;
                font-size: 13px * LayoutConstants.font-scale;
                font-weight: 500;
                font-family: Theme.default_font;
                color: Theme.text_primary;
                vertical-alignment: center;
            }

            if (!AppI18n.is-rtl): Text {
                text: "v" + AppInfo.version;
                font-size: 11px * LayoutConstants.font-scale;
                font-weight: 400;
                font-family: Theme.default_font;
                color: Theme.text_secondary;
                vertical-alignment: center;
            }
        }

        // Controls Area (Theme Switch + Window Controls)
        HorizontalLayout {
            height: 100%;
            x: AppI18n.is-rtl ? 0 : (parent.width - self.width);
            padding-left: 0px;
            padding-right: 0px;
            spacing: 0px;
            alignment: AppI18n.is-rtl ? start : end;

            // Visual Order (Left to Right):
            // LTR: Switch, Minimize, Close
            // RTL: Close, Minimize, Switch

            if (AppI18n.is-rtl): WindowControlButton {
                text: "\u{E8BB}"; // Close
                hover-color: #E81123;
                clicked => {
                    root.close();
                }
            }
            if (!AppI18n.is-rtl): ThemeSwitch {
                clicked => {
                    root.toggle_theme();
                }
            }

            // Minimize is always in the middle
            WindowControlButton {
                text: "\u{E921}"; // Minimize
                clicked => {
                    root.minimize();
                }
            }

            if (AppI18n.is-rtl): ThemeSwitch {
                clicked => {
                    root.toggle_theme();
                }
            }
            if (!AppI18n.is-rtl): WindowControlButton {
                text: "\u{E8BB}"; // Close
                hover-color: #E81123;
                clicked => {
                    root.close();
                }
            }
        }
    }
}
